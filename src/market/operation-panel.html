<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<!-- <link rel="import" href="../../bower_components/paper-button/paper-button.html"> -->
<dom-module id="operation-panel" fit>
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment paper-material-styles"></style>
        <style include="shared-styles">
            :host {
                display: block;
                --paper-tab-content-unselected: {
                    background-color: white;
                    color: var(--app-text-color-light);
                } --paper-tab-ink: transparent;
                /*--paper-tabs-selection-bar-color: transparent;*/
            }

            paper-tab[name="sell"] {
                color: var(--app-red-color);
            }

            paper-tab[name="buy"] {
                color: var(--app-green-color);
            }

            .container {
                @apply --layout-horizontal;
                @apply --layout-justified;
                @apply --layout-start;
                padding: 32px 32px 0;
                /*min-height: 120px;*/
            }

            .seperator {
                margin-top: 30px;
                color: var(--app-text-color-light);
            }

            vaadin-text-field {
                min-width: 210px;
                height: 80px;
            }

            balance-text-field {
                min-width: 210px;
                height: 80px;
            }

            paper-button {
                height: 36px;
                width: 210px;
                margin-top: 22px;
            }

            .sell paper-button {
                background-color: var(--paper-red-500);
                color: white;
            }

            .sell paper-button:hover {
                background-color: var(--paper-red-700);
            }

            .buy paper-button {
                background-color: var(--paper-green-500);
                color: white;
            }

            .buy paper-button:hover {
                background-color: var(--paper-green-700);
            }

            div.balance {
                padding: 0 32px 2px;
                font-size: 12px;
            }

            div.common {
                color: var(--app-primary-color);
            }

            div.error {
                color: var(--google-red-500);
            }

        </style>
        <global-variable key="wallet" value="{{wallet}}"></global-variable>
        <global-variable key="token-price" value="{{priceQuote}}"></global-variable>
        <global-variable key="app-config" value="{{appConfig}}"></global-variable>
        <global-variable key="balances-raw" value="{{balancesRaw}}"></global-variable>

        <global-variable key="settings-lrcFee" value="{{settingsLrcFee}}"></global-variable>
        <global-variable key="settings-relay" value="{{settingsRelay}}"></global-variable>
        <global-variable key="settings-gasPrice" value="{{settingsGasPrice}}"></global-variable>
        <global-variable key="settings-version" value="{{settingsVersion}}"></global-variable>
        <global-variable key="settings-marginSplit" value="{{settingsMarginSplit}}"></global-variable>

        <paper-tabs selected="{{sellOrBuy}}" attr-for-selected="name">
            <paper-tab name="buy">Buy</paper-tab>
            <paper-tab name="sell">Sell</paper-tab>
        </paper-tabs>
        <iron-pages selected="{{sellOrBuy}}" attr-for-selected="name">
            <div name="sell">
                <div class="sell container">
                    <balance-text-field id="sellAmount" label="[[tokens.token]] Quantity" value="{{sellAmount}}"
                                       pattern="[[_numPatten(tokens.precision)]]"
                                       error-message="sellAmountError"  max="[[tokensBalance]]" min="[[tokens.minTradeValue]]">
                        <div slot="suffix">[[tokens.unit]]</div>
                    </balance-text-field>
                    <div class="seperator">&times;</div>
                    <vaadin-text-field label="[[tokens.token]]/[[tokenb.token]] Price" value="{{sellPrice}}"
                                       pattern="[[_numPatten(marketPrecision)]]"
                                       error-message="number with max [[marketPrecision]] precision">
                        <div slot="suffix">[[tokenb.unit]]/[[tokens.unit]]</div>
                    </vaadin-text-field>
                    <div class="seperator">=</div>
                    <balance-text-field disabled label="[[tokenb.token]] Total" value="{{sellTotal}}"
                                       error-message="[[sellTotalError]]">
                        <div slot="suffix">[[tokenb.unit]]</div>
                    </balance-text-field>
                    <div class="seperator">&nbsp;</div>
                    <paper-button on-click="placeSellOrder" id="sellButton">Sell</paper-button>
                </div>
                <div class="balance">
                    <div class="error">
                        <template is="dom-if" if="[[!isEnough(tokenb.minTradeValue,sellTotal)]]">
                            The min trade value of [[tokenb.token]] must be bigger  than [[tokenb.minTradeValue]]
                        </template>
                        <template is="dom-if"
                                  if="[[!bothNonEnough(sellAmount,tokensBalance,tokensAllowance,tokens,lrcFee)]]">
                            <template is="dom-if" if="[[!isBalanceEnough(sellAmount,tokensBalance,tokens,lrcFee)]]">
                                [[_showBalanceNonEnough(tokensBalance,tokens,lrcFee,sellAmount)]].<br>
                            </template>
                        </template>
                        <template is="dom-if"
                                  if="[[bothNonEnough(sellAmount,tokensBalance,tokensAllowance,tokens,lrcFee)]]">
                            [[_showBothNonEnough(tokensBalance,tokensAllowance,tokens,sellAmount,lrcFee)]]
                        </template>
                        <template is="dom-if" if="[[!isEnoughFee(lrcFee,lrcBalance,tokens)]]">
                            You have insufficient LRC balance([[lrcBalance]]) to afford LRC fee, we will set Margin Split to be 100% if you continue to place order
                        </template>
                    </div>
                    <div class="common">
                        <template is="dom-if"
                                  if="[[!nonEnough(sellAmount, tokensBalance,tokensAllowance,tokens,lrcFee)]]">
                            Your balance is [[tokensBalance]].
                            Your allowance is [[tokensAllowance]].
                            <template is="dom-if" if="[[isAllowanceWarn(tokensAllowance,tokens)]]">
                                <a href="/#/approve/[[tokens.token]]" tabindex="-1"> Set allowance to
                                    [[_numFormat(tokenb.allowance,tokenb.digits,tokenb.precision)]] </a>
                            </template>
                            <br> [[_showAmountInfo(tokens, sellAmount, priceQuote,settingsLrcFee)]]
                        </template>
                        <template is="dom-if"
                                  if="[[!bothNonEnough(sellAmount,tokensBalance,tokensAllowance,tokens,lrcFee)]]">
                            <template is="dom-if" if="[[!isBalanceEnough(sellAmount,tokensAllowance,tokens,lrcFee)]]">
                                You have insufficient allowance([[tokensAllowance]]). <a
                                    href="/#/approve/[[tokenb.token]]" tabindex="-1"> Improve allowance </a>
                                <br> [[_showAmountInfo(tokens, sellAmount, priceQuote,settingsLrcFee)]]
                            </template>
                        </template>
                    </div>
                </div>

            </div>
            <!-- ----- -->
            <div name="buy">
                <div class="buy container">
                    <balance-text-field id="buyAmount" label="[[tokens.token]] Quantity" value="{{buyAmount}}"
                                       pattern="[[_numPatten(tokens.precision)]]"
                                       error-message="buyAmountError"  min="[[tokens.minTradeValue]]">
                        <div slot="suffix">[[tokens.unit]]</div>
                    </balance-text-field>
                    <div class="seperator">&times;</div>
                    <vaadin-text-field label="[[tokens.token]]/[[tokenb.token]] Price" value="{{buyPrice}}"
                                       pattern="[[_numPatten(marketPrecision)]]"
                                       error-message="number with max [[marketPrecision]] precision">
                        <div slot="suffix">[[tokenb.unit]]/[[tokens.unit]]</div>
                    </vaadin-text-field>
                    <div class="seperator">=</div>
                    <balance-text-field disabled label="[[tokenb.token]] Total" value="{{buyTotal}}"
                                       error-message="[[buyTotalError]]">
                        <div slot="suffix">[[tokenb.unit]]</div>
                    </balance-text-field>
                    <div class="seperator">&nbsp;</div>
                    <paper-button on-click="placeBuyOrder" id="buyButton">Buy</paper-button>
                </div>
                <div class="balance">
                    <div class="error">
                        <template is="dom-if" if="[[!isEnough(tokenb.minTradeValue,buyTotal)]]">
                            The min trade value of [[tokenb.token]] must be bigger  than [[tokenb.minTradeValue]]
                        </template>
                        <template is="dom-if"
                                  if="[[!bothNonEnough(buyTotal,tokenbBalance,tokenbAllowance,tokenb,lrcFee)]]">
                            <template is="dom-if" if="[[!isEnough(buyTotal,tokenbBalance)]]">
                                [[_showBalanceNonEnough(tokenbBalance,tokenb,lrcFee,buyTotal)]].<br>
                            </template>
                        </template>
                        <template is="dom-if" if="[[bothNonEnough(buyTotal,tokenbBalance,tokenbAllowance,lrcFee)]]">
                            [[_showBothNonEnough(tokenbBalance,tokenbAllowance,tokenb,buyTotal,lrcFee)]]
                        </template>
                        <template is="dom-if" if="[[!isEnoughFee(lrcFee,lrcBalance,tokenb)]]">
                            You have insufficient LRC balance( [[lrcBalance]]) to afford LRC fee, we will set Margin Split to be 100% if you continue to place order.
                        </template>
                    </div>
                    <div class="common">
                        <template is="dom-if" if="[[!nonEnough(buyTotal,tokenbBalance,tokenbAllowance,tokenb,lrcFee)]]">
                            Your balance is [[tokenbBalance]].
                            Your allowance is [[tokenbAllowance]].
                            <template is="dom-if" if="[[isAllowanceWarn(tokenbAllowance,tokenb)]]">
                                <a href="/#/approve/[[tokenb.token]]" tabindex="-1"> Set allowance to
                                    [[_numFormat(tokenb.allowance,tokenb.digits,tokenb.precision)]] </a>
                            </template>
                            <br> [[_showAmountInfo(tokenb, buyTotal, priceQuote,settingsLrcFee)]]
                        </template>
                        <template is="dom-if"
                                  if="[[!bothNonEnough(buyTotal,tokenbBalance,tokenbAllowance,tokenb,lrcFee)]]">
                            <template is="dom-if" if="[[!isBalanceEnough(buyTotal,tokenbAllowance,tokenb,lrcFee)]]">
                                You have insufficient allowance([[tokenbAllowance]]).
                                <a href="/#/approve/[[tokenb.token]]" tabindex="-1"> Improve allowance </a>
                                <br> [[_showAmountInfo(tokenb, buyTotal, priceQuote,settingsLrcFee)]]
                            </template>
                        </template>
                    </div>
                </div>
            </div>
            </div>
        </iron-pages>
    </template>
    <script>


        class OperationPanel extends AppConfigMixin(Polymer.Element) {
            static get is() {
                return 'operation-panel';
            }

            static get properties() {
                return {
                    page: String,
                    subpage: String,
                    market: {
                        type: String,
                        computed: '_computedMarket(page, subpage)'
                    },
                    marketPrecision: {
                        type: Number,
                        computed: '_computePrecision(market,appConfig)'
                    },
                    tokens: {
                        type: Object,
                        computed: '_computeTokenS(market,appConfig)'
                    },
                    tokenb: {
                        type: Object,
                        computed: '_computeTokenB(market,appConfig)'
                    },
                    lrc: {
                        type: Object,
                        computed: '_computelrc(appConfig)'
                    },
                    sellOrBuy: {
                        type: String,
                        value: "buy",
                        observer: '_changeTab'
                    },
                    buyAmount: {
                        type: Number,
                        value: 0
                    },
                    buyPrice: {
                        type: Number,
                        value: 0
                    },
                    buyTotal: {
                        type: Number,
                        computed: '_computeBuyTotal(buyAmount, buyPrice,tokenb)'
                    },
                    sellAmount: {
                        type: Number,
                        value: 0
                    },
                    sellPrice: {
                        type: Number,
                        value: 0
                    },
                    sellTotal: {
                        type: Number,
                        computed: '_computeSellTotal(sellAmount, sellPrice,tokenb)',

                    },
                    tokensBalance: Number,
                    tokensAllowance: Number,
                    tokenbBalance: Number,
                    tokenbAllowance: Number,
                    lrcBalance: Number,
                    lrcAllowance: Number,
                    lrcFee: Number
                };
            }

            ready() {
                super.ready();
                this.$.buyAmount.focus();
            }

            _computedMarket(page, subpage) {
                if (page && "market" === page && subpage) return subpage;
            }

            _changeTab() {
                if ("sell" == this.sellOrBuy) {
                    this.$.sellAmount.focus();
                } else {
                    this.$.buyAmount.focus();
                }
            }

            static get observers() {
                return ['buyButtonState(buyAmount,tokenb,tokens,buyPrice,marketPrecision,buyTotal,tokenbBalance,lrcBalance,lrcFee)',
                    'computeTokenBalances(tokens,tokenb,lrc,balancesRaw)',
                    'sellButtonState(sellAmount,tokenb,tokens,sellPrice,marketPrecision,tokensBalance,sellTotal, lrcBalance, lrcFee)'];
            }

            _computePrecision(market, appConfig) {
                if (market && appConfig) {
                    return Number(appConfig.marketMap[market.toUpperCase()].pricePrecision);
                }
            }


            buyButtonState(buyAmount, tokenb,tokens, buyPrice, marketPrecision, buyTotal, tokenbBalance, lrcBalance, lrcFee) {

                if (tokenb && tokens && buyAmount && new RegExp(this._numPatten(tokens.precision)).test(buyAmount.toString()) && Number(buyAmount) >= tokens.minTradeValue
                        && buyPrice && new RegExp(this._numPatten(marketPrecision)).test(buyPrice.toString())
                        && buyTotal && Number(buyTotal)>=tokenb.minTradeValue && tokenbBalance  && lrcBalance>=0 && lrcFee>=0 && buyTotal <= tokenbBalance) {
                    this.$.buyButton.disabled = false;
                    this.$.buyButton.style.backgroundColor = 'var(--paper-green-500)';
                } else {
                    this.$.buyButton.disabled = true;
                    this.$.buyButton.style.backgroundColor = 'var(--paper-grey-500)';
                }
            }

            sellButtonState(sellAmount, tokenb, tokens, sellPrice, marketPrecision, tokensBalance, sellTotal, lrcBalance, lrcFee) {

                if (tokens && sellAmount && new RegExp(this._numPatten(tokens.precision)).test(sellAmount.toString()) && Number(sellAmount) >= tokens.minTradeValue
                        && marketPrecision && sellPrice && new RegExp(this._numPatten(marketPrecision)).test(sellPrice.toString())
                        && tokensBalance && Number(tokensBalance) && sellTotal && sellTotal >= tokenb.minTradeValue && lrcBalance >=0 && lrcFee >=0  &&  Number(sellAmount) <= tokensBalance) {
                    this.$.sellButton.disabled = false;
                    this.$.sellButton.style.backgroundColor = 'var(--paper-green-500)';
                } else {
                    this.$.sellButton.disabled = true;
                    this.$.sellButton.style.backgroundColor = 'var(--paper-grey-500)';
                }

            }

            _computeTokenS(market, appConfig) {
                if (market && appConfig) {
                    const tokenPair = market.split('-');
                    const tokenx = tokenPair[0];
                    return _.find(appConfig.tokens, {token: tokenx});
                }
            }

            _computeTokenB(market, appConfig) {

                if (market && appConfig) {
                    const tokenPair = market.split('-');
                    const tokenx = tokenPair[1];
                    return _.find(appConfig.tokens, {token: tokenx});
                }
            }

            _computelrc(appConfig) {
                if (appConfig) {
                    return _.find(appConfig.tokens, {token: "LRC"});
                }
            }


            _numPatten(precision) {
                return "^[1-9]\\d*(\\.\\d{1," + precision + "})?|0\\.(\\d{1," + (precision - 1) + "})?[1-9]$";
            }

            _computeBuyTotal(amount, price, tokenb) {
                if (amount && price && Number(price) > 0 && tokenb) {
                    return Math.ceil((amount * price) * Number('1e' + tokenb.precision)) / Number('1e' + tokenb.precision);
                }
            }

            _computeSellTotal(amount, price, tokenb) {
                if (amount && price && Number(price) > 0 && tokenb) {
                    return Math.floor((amount * price) * Number('1e' + tokenb.precision)) / Number('1e' + tokenb.precision);
                }
            }


            async placeBuyOrder() {

                try {
                    if (!this.wallet) {

                        const detail = {
                            text: 'Set Wallet First!',
                            category: 'warning',
                            duration: 5000,
                            link: '/#/wallet',
                            linkText: 'Go to set Wallet'
                        };

                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: detail
                        }));

                        return;
                    }
                    if (!this.appConfig || !this.settingsMarginSplit || !this.settingsLrcFee) {
                        return;
                    }
                    if (this.appConfig.whiteList && this.appConfig.whiteList.indexOf(this.wallet.address) < 0) {
                        const detail = {
                            text: 'Your address is not in white list, could not submit order',
                            category: "warning",
                            duration: 5000
                        };
                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: detail
                        }));
                        return;
                    }

                    let data = {};
                    const detail = {};
                    const raws = [];
                    const gasLimit = '0x14820';
                    const gasPrice = '0x' + (Number(this.settingsGasPrice) * 1e9).toString(16);
                    let currentVersion = this.settingsVersion;
                    const spender = this.appConfig.delegateAddress;
                    data.protocol = this.appConfig.contractVersionMap[currentVersion].address;
                    data.owner = this.wallet.address;
                    data.tokenS = this.tokenb.address;
                    data.tokenB = this.tokens.address;
                    data.amountS = '0x' + Number((Number(this.buyTotal) * Number('1e' + this.tokenb.digits)).toFixed(0)).toString(16);
                    data.amountB = '0x' + (Number(this.buyAmount) * Number('1e' + this.tokens.digits)).toString(16);
                    data.timestamp = Number((new Date().getTime() / 1000).toFixed(0));
                    data.ttl = 10 * 24 * 3600;
                    data.salt = Math.round(Math.random() * 1e8);
                    if (!this.lrc) {
                        const detail = {
                            text: 'Can\'t get LRC Config',
                            category: "warning",
                            duration: 5000
                        };
                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: detail
                        }));
                        return;
                    }
                    data.lrcFee = this.isEnoughFee(this.lrcFee, this.lrcBalance,this.tokenb) ? '0x' + (this._showAmount(this.lrcFee) * Number('1e' + this.lrc.digits)).toString(16) : '0x0';
                    data.buyNoMoreThanAmountB = true;
                    data.marginSplitPercentage = Number(data.lrcFee) !==0 ? Number(this.settingsMarginSplit) : 100;
                    detail.order = {
                        raw: JSON.stringify(data),
                        subTitle: "Place an order",
                        description:"Buy "+Number(this.buyAmount)+" "+ this.tokens.token.toUpperCase()+" with "+ Number(this.buyTotal) +" "+ this.tokenb.token.toUpperCase()
                    };

                    const balances = _.keyBy(this.balancesRaw.result.tokens, 'token');
                    const balance = balances[this.tokenb.token.toUpperCase()] ? Number(balances[this.tokenb.token.toUpperCase()].balance) : 0;
                    const allowance = balances[this.tokenb.token.toUpperCase()].allowance ? Number(balances[this.tokenb.token.toUpperCase()].allowance) : 0;
                    const defaultValue = Number(this.tokenb.allowance);

                    if (this.tokenb.token.toUpperCase() === 'LRC') {

                        const require = Number(data.amounts) + Number(data.lrcFee);

                        if (require > allowance) {

                            let amount;

                            if (balance < defaultValue) {
                                amount = balance;
                            }

                            if (balance > defaultValue) {
                                amount = defaultValue > require ? defaultValue : require
                            }

                            const tx = {};
                            tx.gasPrice = gasPrice;
                            tx.gasLimit = gasLimit;
                            tx.to = this.tokenb.address;
                            tx.value = '0x0';

                            if (allowance === 0) {
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));
                                raws.push({"raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of "+this.tokenb.token.toUpperCase(),
                                    "description":"Set allowance  to " + Number(amount)/Number('1e'+this.tokenb.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            } else {
                                tx.data = signer.generateApproveData(spender, '0x0');
                                const cancelRaw = JSON.stringify(tx);
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));

                                raws.push({
                                    "raw": cancelRaw,
                                    "subTitle": "Cancel Older Authorization Of " + this.tokenb.token.toUpperCase(),
                                    "description": "Set allowance  to 0 first in order to set Allowance to "+ Number(amount)/Number('1e'+this.tokenb.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                }, {"raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of "+this.tokenb.token.toUpperCase(),
                                    "description":"Set allowance  to " + Number(amount)/Number('1e'+this.tokenb.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            }
                        }

                    } else {

                        if (Number(data.amountS) > allowance) {

                            let amount;

                            if (balance < defaultValue) {
                                amount = balance;
                            }

                            if (balance > defaultValue) {
                                amount = defaultValue > Number(data.amountS) ? defaultValue : Number(data.amountS)
                            }

                            const tx = {};
                            tx.gasPrice = gasPrice;
                            tx.gasLimit = gasLimit;
                            tx.to = this.tokenb.address;
                            tx.value = '0x0';

                            if (allowance === 0) {
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));
                                raws.push({
                                    "raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of " + this.tokenb.token.toUpperCase(),
                                    "description":"Set allowance  to " + Number(amount)/Number('1e'+this.tokenb.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            } else {
                                tx.data = signer.generateApproveData(spender, '0x0');
                                const cancelRaw = JSON.stringify(tx);
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));

                                raws.push({
                                    "raw": cancelRaw,
                                    "subTitle": "Cancel Older Authorization Of " + this.tokenb.token.toUpperCase(),
                                    "description": "Set allowance  to 0 first in order to set Allowance to "+ Number(amount)/Number('1e'+this.tokenb.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                }, {
                                    "raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of " + this.tokenb.token.toUpperCase(),
                                    "description":"Set allowance  to " + Number(amount)/Number('1e'+this.tokenb.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            }
                        }


                        if (Number(data.lrcFee) > this.lrcAllowance * Number('1e' + this.lrc.digits)) {

                            const defaultlrc = Number(this.lrc.allowance);
                            const lrcBalance = this.lrcBalance * Number('1e' + this.lrc.digits);
                            const lrcFee = Number(data.lrcFee) ;

                            let lrcAmount;
                            if (defaultlrc >= lrcBalance) {
                                lrcAmount = lrcBalance;
                            }

                            if (defaultlrc < lrcBalance) {
                                lrcAmount = defaultlrc > lrcFee ? defaultlrc : lrcFee;
                            }

                            const tx = {};
                            tx.gasPrice = gasPrice;
                            tx.gasLimit = gasLimit;
                            tx.to = this.tokenb.address;
                            tx.value = '0x0';

                            if (this.lrcAllowance === 0) {
                                tx.data = signer.generateApproveData(spender, '0x' + Number(lrcAmount).toString(16));
                                raws.push({"raw": JSON.stringify(tx), "subTitle": " New Authorization Of LRC ",
                                    "description":"Improve LRC Allowance to " +Number(lrcAmount)/Number('1e'+this.lrc.digits) +" to pay the order fee"+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."});
                            } else {
                                tx.data = signer.generateApproveData(spender, '0x0');
                                const cancelRaw = JSON.stringify(tx);
                                tx.data = signer.generateApproveData(spender, '0x' + Number(lrcAmount).toString(16));

                                raws.push({
                                    "raw": cancelRaw,
                                    "subTitle": "Cancel Older Authorization Of LRC",
                                    "description":"Set LRC allowance to 0 in order to improve it to "+Number(lrcAmount)/Number('1e'+this.lrc.digits) +" to pay the order fee with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                }, {"raw": JSON.stringify(tx), "subTitle": "New Authorization Of LRC",
                                    "description":"Improve LRC Allowance to " +Number(lrcAmount)/Number('1e'+this.lrc.digits) +" to pay the order fee"+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            }

                        }
                    }
                    const ETHBalance = balances['ETH'] ? balances['ETH'].balance : 0;
                    if (ETHBalance < raws.length * (Number(gasLimit) * Number(gasPrice))) {
                        const errorDetail = {
                            text: 'You has insufficient ETH balance for gasLimit * gasPrice',
                            category: "warning",
                            duration: 8000
                        };
                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: errorDetail
                        }));
                        return;
                    }
                    detail.raws = raws;
                    this.dispatchEvent(new CustomEvent('placeorder', {
                        bubbles: true,
                        composed: true,
                        detail: detail
                    }));
                } catch (e) {

                    const detail = {
                        text: e.message,
                        category: "error",
                        duration: 5000
                    };
                    this.dispatchEvent(new CustomEvent('notification', {
                        bubbles: true,
                        composed: true,
                        detail
                    }));
                }
            }

            async placeSellOrder() {

                try {
                    if (!this.wallet) {
                        const noWalletDetail = {
                            text: 'Set Wallet First!',
                            category: "warning",
                            duration: 5000,
                            link: '/#/wallet',
                            linkText: 'Go to set Wallet'
                        };
                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: noWalletDetail
                        }));

                        return
                    }
                    if (!this.appConfig || !this.settingsMarginSplit || !this.settingsLrcFee) {
                        return;
                    }
                    if (this.appConfig.whiteList && this.appConfig.whiteList.indexOf(this.wallet.address) < 0) {
                        const detail = {
                            text: 'Your address is not in white list, could not submit order',
                            category: "warning",
                            duration: 5000
                        };
                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: detail
                        }));
                        return;
                    }
                    const detail = {};
                    const data = {};
                    const raws = [];
                    const gasLimit = '0x14820';
                    const gasPrice = '0x' + (Number(this.settingsGasPrice) * 1e9).toString(16);
                    let currentVersion = this.settingsVersion;
                    const spender = this.appConfig.delegateAddress;
                    data.protocol = this.appConfig.contractVersionMap[currentVersion].address;;
                    data.owner = this.wallet.address;
                    data.tokenS = this.tokens.address;
                    data.tokenB = this.tokenb.address;
                    data.amountS = '0x' + (Number(this.sellAmount) * Number('1e' + this.tokens.digits)).toString(16);
                    data.amountB = '0x' + Number((Number(this.sellTotal) * Number('1e' + this.tokenb.digits)).toFixed(0)).toString(16);
                    data.timestamp = Number((new Date().getTime() / 1000).toFixed(0));
                    data.ttl = 30 * 24 * 3600;
                    data.salt = Math.round(Math.random() * 1e8);

                    if (!this.lrc) {
                        const detail = {text: 'Can\'t get LRC Config', category: "warning", duration: 5000};
                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: detail
                        }));
                        return;
                    }
                    data.lrcFee = this.isEnoughFee(this.lrcFee, this.lrcBalance,this.tokens) ? '0x' + (this._showAmount(this.lrcFee) * Number('1e' + this.lrc.digits)).toString(16) : '0x0';
                    data.buyNoMoreThanAmountB = false;
                    data.marginSplitPercentage = Number(data.lrcFee) !==0 ? Number(this.settingsMarginSplit) : 100;
                    detail.order = {
                        raw: JSON.stringify(data),
                        subTitle: "Place an order",
                        description:"Sell "+ Number(this.sellAmount) +" "+ this.tokens.token.toUpperCase()+"  to get "+ Number(this.sellTotal) +" "+ this.tokenb.token.toUpperCase()
                    };

                    const balances = _.keyBy(this.balancesRaw.result.tokens, 'token');
                    const balance = balances[this.tokens.token.toUpperCase()] ? Number(balances[this.tokens.token.toUpperCase()].balance) : 0;
                    const allowance = balances[this.tokens.token.toUpperCase()].allowance ? Number(balances[this.tokens.token.toUpperCase()].allowance) : 0;
                    const defaultValue = Number(this.tokens.allowance);

                    if (this.tokens.token.toUpperCase() === 'LRC') {

                        const require = Number(data.amountS) + Number(data.lrcFee) ;

                        if (require > allowance) {
                            let amount;

                            if (balance < defaultValue) {
                                amount = balance;
                            }

                            if (balance > defaultValue) {
                                amount = defaultValue > require ? defaultValue :require
                            }

                            const tx = {};
                            tx.gasPrice = gasPrice;
                            tx.gasLimit = gasLimit;
                            tx.to = this.tokens.address;
                            tx.value = '0x0';

                            if (allowance === 0) {
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));
                                raws.push({
                                    "raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of " + this.tokens.token.toUpperCase(),
                                    "description":"Set allowance  to " + Number(amount)/Number('1e'+this.tokens.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            } else {
                                tx.data = signer.generateApproveData(spender, '0x0');
                                const cancelRaw = JSON.stringify(tx);
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));
                                raws.push({
                                    "raw": cancelRaw,
                                    "subTitle": "Cancel Older Authorization Of " + this.tokens.token.toUpperCase(),
                                    "description": "Set allowance  to 0 first in order to set Allowance to "+ Number(amount)/Number('1e'+this.tokens.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                }, {
                                    "raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of " + this.tokens.token.toUpperCase(),
                                    "description": "Improve allowance  to " + Number(amount)/Number('1e'+this.tokens.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            }
                        }

                    } else {
                        if (Number(data.amountS) > allowance) {
                            let amount;

                            if (balance < defaultValue) {
                                amount = balance;
                            }

                            if (balance > defaultValue) {
                                amount = defaultValue > Number(data.amountS) ? defaultValue : Number(data.amountS)
                            }

                            const tx = {};
                            tx.gasPrice = gasPrice;
                            tx.gasLimit = gasLimit;
                            tx.to = this.tokens.address;
                            tx.value = '0x0';

                            if (allowance === 0) {
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));
                                raws.push({
                                    "raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of " + this.tokens.token.toUpperCase(),
                                    "description":"Set allowance for  to " + Number(amount)/Number('1e'+this.tokens.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });
                            } else {
                                tx.data = signer.generateApproveData(spender, '0x0');
                                const cancelRaw = JSON.stringify(tx);
                                tx.data = signer.generateApproveData(spender, '0x' + Number(amount).toString(16));
                                raws.push({
                                    "raw": cancelRaw,
                                    "subTitle": "Cancel Older Authorization Of " + this.tokens.token.toUpperCase(),
                                    "description":"Set allowance  to 0 first in order to set Allowance to "+ Number(amount)/Number('1e'+this.tokens.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                }, {
                                    "raw": JSON.stringify(tx),
                                    "subTitle": "New Authorization Of " + this.tokens.token.toUpperCase(),
                                    "description":"Improve allowance to " + Number(amount)/Number('1e'+this.tokens.digits)+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                });

                            }
                        }

                        if (Number(data.lrcFee) > this.lrcAllowance * Number('1e' + this.lrc.digits)) {
                            const defaultlrc = Number(this.lrc.allowance);
                            const lrcBalance = this.lrcBalance * Number('1e' + this.lrc.digits);
                            const lrcFee = Number(data.lrcFee) ;

                            let lrcAmount;
                            if (defaultlrc >= lrcBalance) {
                                lrcAmount = lrcBalance;
                            }

                            if (defaultlrc < lrcBalance) {
                                lrcAmount = defaultlrc > lrcFee ? defaultlrc : lrcFee;
                            }

                            const tx = {};
                            tx.gasPrice = gasPrice;
                            tx.gasLimit = gasLimit;
                            tx.to = this.tokenb.address;
                            tx.value = '0x0';

                            if (this.lrcAllowance === 0) {
                                tx.data = signer.generateApproveData(spender, '0x' + Number(lrcAmount).toString(16));
                                raws.push({"raw": JSON.stringify(tx),
                                    "subTitle": " New Authorization Of LRC ",
                                    "description":"Improve LRC Allowance to " +Number(lrcAmount)/Number('1e'+this.lrc.digits) +" to pay the order fee"+" with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."});
                            } else {
                                tx.data = signer.generateApproveData(spender, '0x0');
                                const cancelRaw = JSON.stringify(tx);
                                tx.data = signer.generateApproveData(spender, '0x' + Number(lrcAmount).toString(16));

                                raws.push({
                                    "raw": cancelRaw,
                                    "subTitle": "Cancel Older Authorization Of LRC",
                                    "description":"Set LRC allowance to 0 in order to improve it to "+Number(lrcAmount)/Number('1e'+this.lrc.digits) +" to pay the order fee with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."
                                }, {"raw": JSON.stringify(tx), "subTitle": "New Authorization Of LRC",
                                    "description":"Improve LRC Allowance to " +Number(lrcAmount)/Number('1e'+this.lrc.digits) +" to pay the order fee with gas is "+Number(gasLimit)+ " and gasPrice is " + Number(gasPrice)/1e9 + "Gwei."});
                            }
                        }
                    }


                    const ETHBalance = balances['ETH'] ? balances['ETH'].balance : 0;
                    if (ETHBalance < raws.length * (Number(gasLimit) * Number(gasPrice))) {
                        const errorDetail = {
                            text: 'You has insufficient ETH balance for gasLimit * gasPrice',
                            category: "warning",
                            duration: 8000
                        };
                        this.dispatchEvent(new CustomEvent('notification', {
                            bubbles: true,
                            composed: true,
                            detail: errorDetail
                        }));
                        return;
                    }
                    detail.raws = raws;
                    this.dispatchEvent(new CustomEvent('placeorder', {
                        bubbles: true,
                        composed: true,
                        detail: detail
                    }));


                } catch (e) {

                    const detail = {text: e.message, category: "error", duration: 5000};

                    this.dispatchEvent(new CustomEvent('notification', {
                        bubbles: true,
                        composed: true,
                        detail
                    }));
                }
            }

            isAllowanceWarn(allowance, token) {
                if (allowance && token) {
                    return allowance < token.allowanceWarn / Number('1e' + token.digits);
                }
                return false;
            }

            nonEnough(amount, balance, allowance, token, lrcFee) {

                if (balance >= 0 && allowance >= 0 && Number(amount) >= 0 && token) {
                    return (lrcFee && token.token.toUpperCase() === 'LRC') ?
                        Number(amount) + lrcFee > balance || Number(amount) + lrcFee > allowance :
                        Number(amount) > balance || Number(amount) > allowance
                }
                return false;
            }

            bothNonEnough(amount, balance, allowance, token, lrcFee) {
                if (balance >= 0 && allowance >= 0 && Number(amount) >= 0 && token) {
                    return (lrcFee && token.token.toUpperCase() === 'LRC') ?
                        Number(amount) + lrcFee > balance && Number(amount) + lrcFee > allowance :
                        Number(amount) > balance && Number(amount) > allowance
                }
                return false
            }

            isEnough(require, left) {

                if (left >= 0 && Number(require) >= 0) {
                    return left >= Number(require)
                }
                return true;
            }

            isEnoughFee(lrcFee, lrcBalance, token) {
                if (lrcFee >= 0 && lrcBalance >= 0 && token) {
                    return token.token.toUpperCase() === "LRC" ? true : lrcFee <= lrcBalance;
                }
                return true
            }

            isBalanceEnough(require, left, token, lrcFee) {
                if (left >= 0 && Number(require) >= 0 && token) {
                    return (lrcFee && token.token.toUpperCase() === 'LRC') ? left >= Number(require) + lrcFee : left >= Number(require)
                }
                return true
            }


            computeTokenBalances(tokens, tokenb, lrc, rawBalances) {

                if (rawBalances) {
                    const balances = _.keyBy(rawBalances.result.tokens, 'token');
                    if (tokens) {
                        const balance = balances[tokens.token.toUpperCase()] ? Number(balances[tokens.token.toUpperCase()].balance) : 0;
                        const allowance = balances[tokens.token.toUpperCase()] ? Number(balances[tokens.token.toUpperCase()].allowance) : 0;
                        this.tokensBalance = Number(((balance ? balance : 0) / Number('1e' + tokens.digits)).toFixed(tokens.precision));
                        this.tokensAllowance = Number(((allowance ? allowance : 0 ) / Number('1e' + tokens.digits)).toFixed(tokens.precision));

                    }
                    if (tokenb) {
                        const balance = balances[tokenb.token.toUpperCase()] ? Number(balances[tokenb.token.toUpperCase()].balance) : 0;
                        const allowance = balances[tokenb.token.toUpperCase()].allowance ? Number(balances[tokenb.token.toUpperCase()].allowance) : 0;
                        this.tokenbBalance = Number(((balance ? balance : 0) / Number('1e' + tokenb.digits)).toFixed(tokenb.precision));
                        this.tokenbAllowance = Number(((allowance ? allowance : 0) / Number('1e' + tokenb.digits)).toFixed(tokenb.precision));
                    }

                    if (lrc) {
                        const balance = balances[lrc.token.toUpperCase()] ? Number(balances[lrc.token.toUpperCase()].balance) : 0;
                        const allowance = balances[lrc.token.toUpperCase()].allowance ? Number(balances[lrc.token.toUpperCase()].allowance) : 0;
                        this.lrcBalance = Number(((balance ? balance : 0) / Number('1e' + lrc.digits)).toFixed(lrc.precision));
                        this.lrcAllowance = Number(((allowance ? allowance : 0) / Number('1e' + lrc.digits)).toFixed(lrc.precision));
                    }

                }
            }

            _showAmount(amount) {
                return Math.floor(amount * 100) / 100;
            }

            _numFormat(amount, digits, precision) {

                if (amount && digits && precision) {
                    return (Number(amount) / Number('1e' + digits)).toFixed(precision)
                }
            }

            _showAmountInfo(selectToken, sellAmount, priceQuote, settingsLrcFee) {
                if (selectToken && sellAmount && priceQuote && Number(sellAmount)) {
                    let selectTokenPrice = priceQuote.getPrice(selectToken.token);
                    let amount = sellAmount * selectTokenPrice;
                    let fee = amount * this.settingsLrcFee / 1000;
                    let lrcFee = fee / priceQuote.getPrice("LRC");
                    this.lrcFee = lrcFee;
                    let  info =  "Estimated order value: " + this._showAmount(amount) + ' ' + priceQuote.currency + ". Estimated LRC fee value: " + this._showAmount(fee) + ' ' + priceQuote.currency
                        + " (" + this._showAmount(amount) + ' * ' + settingsLrcFee + '‰, about ' + this._showAmount(lrcFee) + " LRC). " ;

                    if(this._showAmount(lrcFee) === 0 ){
                        info =  info + "Since lrc fee is 0, we will set margin split to 100%."
                    }
                    return info;
                }
            }

            _showBalanceNonEnough(balance, token, lrcFee, amount) {
                if (token && token.token.toUpperCase() === 'LRC') {
                    return "You have insufficient balance(" + balance + ") to place an order with value(" + amount + ") and lrcFee(" + lrcFee + ") ";
                } else {
                    return "You have insufficient balance(" + balance + ") to place an order with value(" + amount + ")";
                }

            }


            _showBothNonEnough(balance, allowance, token, amount, lrcFee) {

                if (token && token.token.toUpperCase() === 'LRC') {
                    return "You have insufficient balance(" + balance + ") and insufficient allowance(" + allowance + ") to place an order with value(" + amount + ") and lrcFee(" + lrcFee + ") ";
                } else {
                    return "You have insufficient balance(" + balance + ")and insufficient allowance(" + allowance + ") to place an order with value(" + amount + ")";
                }

            }


        }

        window.customElements.define(OperationPanel.is, OperationPanel);
    </script>
</dom-module>