<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<!-- <link rel="import" href="../../bower_components/paper-button/paper-button.html"> -->
<dom-module id="trade-table" fit>
    <template>
        <style include="shared-styles">
         :host {
            display: block;
         }
         div.long-hash {
            width: 80px;
         }
        </style>
        <global-variable key="app-config" value="{{appConfig}}"></global-variable>
        <iron-ajax auto url="https://raw.githubusercontent.com/Loopring/mock-relay-data/master/orderFills.json" handle-as="json" last-response="{{resp}}"></iron-ajax>
        <!-- The array is set as the <vaadin-grid>'s "items" property -->
        <vaadin-grid aria-label="Basic Binding Example" items="[[resp.result.data]]">
            <template is="dom-if" if="[[_showOrder()]]">
                <vaadin-grid-column width="40px">
                    <template class="header">
                        <div class="left-aligned">Ring</div>
                    </template>
                    <template>
                        <div class="left-aligned">
                            <a href="[[item.ringLink]]">
                                <div class="long-hash">[[item.ringHash]]</div>
                            </a>
                        </div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column width="40px">
                    <template class="header">
                        <div class="left-aligned">Tx</div>
                    </template>
                    <template>
                        <div class="left-aligned">
                            <a href="[[item.txLink]]" target="_blank">
                                <div class="long-hash">[[item.txHash]]</div>
                            </a>
                        </div>
                    </template>
                </vaadin-grid-column>
            </template>
            <template is="dom-if" if="[[_showRing()]]">
                <vaadin-grid-column width="40px">
                    <template class="header">
                        <div class="left-aligned">Order</div>
                    </template>
                    <template>
                        <div class="left-aligned">
                            <a href="[[item.orderLink]]">
                                <div class="long-hash">[[item.orderHash]]</div>
                            </a>
                        </div>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column width="5px">
                    <template class="header">Index</template>
                    <template>[[item.ringIndex]]</template>
                </vaadin-grid-column>
            </template>
            <vaadin-grid-column width="5px">
                <template class="header">Type</template>
                <template><span style$="color:[[item.typeStyle]]"> [[item.buyOrSell]]</span></template>
            </vaadin-grid-column>
            <vaadin-grid-column width="90px">
                <template class="header">Amount</template>
                <template><pretty-number v="[[item.fillAmountS]]" d=[[item.volumnPrecisionS]] postfix="[[item.unitS]]"></pretty-number></template>
            </vaadin-grid-column>
            <vaadin-grid-column width="30px">
                <template class="header">Price</template>
                <template>
                    <pretty-number v="[[item.price]]" d=[[item.pricePrecision]]"></pretty-number>
                </template>
            </vaadin-grid-column>
            <vaadin-grid-column width="90px">
                <template class="header">Size</template>
                <template><pretty-number v="[[item.fillAmountB]]" d=[[item.volumnPrecisionB]] postfix="[[item.unitB]]"></pretty-number></template>
            </vaadin-grid-column>
            <vaadin-grid-column width="40px">
                <template class="header">Lrc-Fee</template>
                <template><pretty-number v="[[item.feeLrc]]" d=[[appConfig.lrc.precision]]></pretty-number></template>
            </vaadin-grid-column>
            <vaadin-grid-column width="90px">
                <template class="header">Margin-Split</template>
                <template>
                    <pretty-number v="[[item.marginSplit]]" d=[[item.marginSplitPrecision]] postfix="[[item.marginSplitUnit]]"></pretty-number>
                </template>
            </vaadin-grid-column>
            <template is="dom-if" if="[[_showOrder()]]">
                <vaadin-grid-column width="40px">
                    <template class="header">Time</template>
                    <template><time-str seconds="[[item.timestamp]]"></time-str></template>
                </vaadin-grid-column>
            </template>
        </vaadin-grid>
    </template>
    <script>
    class TradeTable extends Polymer.Element {
        static get is() {
            return 'trade-table';
        }

        /**
         * subType: oneof:[order, ring]
         * market: lrc-eos
         */
        static get properties() {
            return {
                token: {
                    type: String,
                },
                subType: {
                    type: String
                },
                orders: {
                    type: Object,
                    computed: '_computeOrders(resp)'
                }
            };
        }

        _showOrder(){
            if(!this.subType) return false
            return "order" === this.subType.toLowerCase()
        }

        _showRing(){
            if(!this.subType) return false
            return "ring" === this.subType.toLowerCase()
        }

        _computOrderItem(item){
            item.ringLink = "#/ring/"+item.ringHash
            item.orderLink = "#/order/"+item.orderHash
            item.txLink = "https://etherscan.io/tx/"+item.txHash
            item.buyOrSell = item.tokenS +"â‡¢"+item.tokenB;
            let precisionS = this._fillMarket(item.tokenS);
            item.volumnPrecisionS = precisionS.pricePrecision;
            item.pricePrecision = precisionS.pricePrecision;
            const tokenSConfig = this.appConfig.tokenMap[item.tokenS.toUpperCase()];
            if (tokenSConfig) {
                item.unitS = tokenSConfig.unit;
            } else {
                item.unitS = "";
            }
            let precisionB = this._fillMarket(item.tokenB)
            item.volumnPrecisionB = precisionB.pricePrecision;
            const tokenBConfig = this.appConfig.tokenMap[item.tokenB];
            if (tokenBConfig) {
                item.unitB = tokenBConfig.unit;
            } else {
                item.unitB = "";
            }

            item.fillAmountS = this._tranHextoNum(item.fillAmountS)
            item.fillAmountB = this._tranHextoNum(item.fillAmountB)
            item.fee = this._tranHextoNum(item.fee)
            item.price = this.calPrice(item.fillAmountB,item.fillAmountS)

            item.feeLrc = this._tranHextoNum(item.feeLrc);
            let marginSplitToken = this.appConfig.tokenMap[item.marginSplitToken.toUpperCase()];
            item.marginSplit = this._tranHextoNum(item.marginSplit);
            item.marginSplitUnit = marginSplitToken.unit
            item.marginSplitPrecision = marginSplitToken.precision;
            return item
        }

        _fillMarket(tokenName){
            const defaultPricePrecision = 3;
            const defaultVolumePrecision = 5;
            const marketConfig = this.appConfig.marketMap[tokenName.toUpperCase()+"-WETH"];
            let pricePrecision = defaultPricePrecision, volumnPrecision = defaultVolumePrecision
            if (marketConfig) {
                pricePrecision = marketConfig.pricePrecision;
                const tokenxConfig = this.appConfig.tokenMap[tokenName];
                if (tokenxConfig) {
                    volumnPrecision = tokenxConfig.precision;
                } else {
                    volumnPrecision = defaultVolumePrecision;
                }
            }
            return {pricePrecision: pricePrecision, volumnPrecision: volumnPrecision}
        }

        _tranHextoNum(hex) {
            if (hex) {
                return Number(hex);
            }
            return '-1';
        }

        _computeOrders(resp){
            if(!resp || !resp.result) return
            return _.map(resp.result.data, o => this._computOrderItem(o));
        }

        _findTokenConfig(address) {
            var tokens = this.appConfig.tokens;
            for (var x in tokens) {
                var token = tokens[x];
                if (token.contract == address) {
                    return token;
                }
            }
        }

        _findSymbol(address) {
            if(!address) return
            var token = this._findTokenConfig(address);
            if (token) {
                return token.unit
            } else {
                return "?";
            }
        }

        calPrice(b, s) {
            if (b && s && s !== 0) {
                return (b / s);
            }
            return 0;
        }
        typeStyle(isBuy) {

            return isBuy ? 'var(--app-green-color)' : 'var(--app-red-color)';
        }

        getType(isBuy) {
            return isBuy ? 'Buy' : 'Sell';
        }
    }

    window.customElements.define(TradeTable.is, TradeTable);
    </script>
</dom-module>