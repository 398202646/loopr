<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="page-settings">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles">
         :host {
            display: block;
        }

        app-toolbar {
            color: white;
            background-color: var(--app-primary-color);
        }

        paper-icon-button {
            color: white;
        }

        .item {
            /*background-color: red;*/
            padding-bottom: 16px;
        }

        .label {
            min-width: 200px;
            color: var(--app-text-color-light);
        }

        vaadin-combo-box {
            width: 260px;
        }

        vaadin-text-field {
            width: 260px;
        }

        .lrcContainer {
            width: 260px;
        }

        .slider {
            width: 80%;
        }

        .value-label {
            width: 20%;
            font-size: 10px;
            @apply(--layout-vertical);
            @apply(--layout-center-justified);
        }

        .contract-address {
            width: 260px;
            height: 15px;
            font-size: 11px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            color: var(--app-text-color-light);
            display: block;
            /*text-align: center;*/
            padding-top: 8px;
            text-decoration: none;
        }
        </style>
        <loopr-page>
            <global-variable key="wallet" value="{{wallet}}"></global-variable>
            <global-variable key="app-config" value="{{appConfig}}"></global-variable>
            <global-variable key="settings-lang" value="{{settingsLang}}"></global-variable>
            <global-variable key="settings-currency" value="{{settingsCurrency}}"></global-variable>
            <global-variable key="settings-relay" value="{{settingsRelay}}"></global-variable>
            <global-variable key="settings-gasPrice" value="{{settingsGasPrice}}"></global-variable>
            <global-variable key="settings-version" value="{{settingsVersion}}"></global-variable>
            <scary-cookie name="settings-currency" value="{{settingsCurrency}}"></scary-cookie>
            <scary-cookie id="settingsLrcFee" name="settings-lrcFee" value="{{settingsLrcFee}}"></scary-cookie>
            <scary-cookie name="settings-relay" value="{{settingsRelay}}"></scary-cookie>
            <scary-cookie name="settings-gasPrice" value="{{settingsGasPrice}}"></scary-cookie>
            <scary-cookie name="settings-version" value="{{settingsVersion}}"></scary-cookie>
            <scary-cookie id="settingsMarginSplit" name="settings-marginSplit" value="{{settingsMarginSplit}}"></scary-cookie>
            <scary-cookie name="settings-lang" value="{{settingsLang}}"></scary-cookie>
            <loopr-toolbar slot="secondary-toolbar" active-tab="settings"></loopr-toolbar>
            <div class="sections">
                <paper-card>
                    <div class="card-content vertical center layout">
                        <div class="vertical layout">
                            <div class="item horizontal center layout">
                                <div class="label">Language</div>
                                <vaadin-combo-box id="lang" placeholder="English" items="{{appConfig.langs}}"></vaadin-combo-box>
                            </div>
                            <div class="item horizontal center layout">
                                <div class="label">Currency</div>
                                <vaadin-combo-box id="currency" placeholder="USD" items="{{appConfig.fiat}}"></vaadin-combo-box>
                            </div>
                            <div class="item horizontal center layout">
                                <div class="label">Relay</div>
                                <vaadin-combo-box id="relay" placeholder="Default Loopring Relay" items="{{appConfig.relays}}"></vaadin-combo-box>
                            </div>
                            <div class="item horizontal center layout">
                                <div class="label">Contract Version</div>
                                <div>
                                    <vaadin-combo-box id="version" placeholder="Default Contract Version" items="{{appConfig.contracts}}" item-label-path="version" item-value-path="version"></vaadin-combo-box>
                                    <a class="contract-address" href="https://etherscan.io/address/[[contractAddress]]" target="_blank">[[contractAddress]]</a>
                                </div>
                            </div>
                            <div class="item horizontal center layout">
                                <div class="label">LRC Fee</div>
                                <vaadin-text-field id="lrcFee" value="{{settingsLrcFee}}"
                                                   pattern="[[_lrcFeePatten()]]"
                                                   error-message="[[_lrcFeeError()]]">
                                    <div slot="suffix">â€°</div>
                                </vaadin-text-field>
                            </div>
                            <div class="item horizontal center layout">
                                <div class="label">Margin Split</div>
                                <vaadin-text-field id="marginSplit" value="{{settingsMarginSplit}}"
                                                   pattern="[[_marginSplitPatten()]]"
                                                   error-message="[[_marginSplitError()]]">
                                    <div slot="suffix">%</div>
                                </vaadin-text-field>
                            </div>
                            <div class="item horizontal center layout">
                                <div class="label">Gas Price</div>
                                <div class="lrcContainer horizontal start-justified layout">
                                    <div class="slider"><paper-slider id="gasPrice" pin min="1" max="60" max-markers="15" step="1" value="{{appConfig.defaultGasPrice}}"></paper-slider></paper-slider></div>
                                    <div class="value-label"><span id="gasPriceLabel" class="caption">{{appConfig.defaultGasPrice}}GWEI</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </paper-card>
                <div class="footer-spacer"></div>
                <loopr-footer></loopr-footer>
            </div>
        </loopr-page>
    </template>
    <script>
    class PageSettings extends Polymer.Element {
        static get is() {
            return 'page-settings';
        }

        static get properties() {
            return {
                cookieValue: Object,
                settingsLrcFee: {
                    type: Number,
                    computed: '_computedLrcFee(appConfig, cookieValues)'
                },
                initContract: {
                    type: String,
                    computed: '_initContract(appConfig, settingsVersion)'
                },
                settingsMarginSplit: {
                    type: Number,
                    computed: '_computedMarginSplit(appConfig, cookieValues)'
                },
                contractAddress: String
            };
        }

        ready() {
            super.ready();

            let cookieValue = {};
            if (this.$.settingsLrcFee.value) {
                cookieValue["settingsLrcFee"] = this.$.settingsLrcFee.value;
            }
            if (this.$.settingsMarginSplit.value) {
                cookieValue["settingsMarginSplit"] = this.$.settingsMarginSplit.value;
            }
            this.cookieValues = cookieValue;

            this.$.lang.value = this.settingsLang || "en";
            this.$.currency.value = this.settingsCurrency || "usd";
            this.$.relay.value = this.settingsRelay || "//relay1.loopring.io";
            this.$.version.value = this.settingsVersion || "0.0.1";
            this.$.gasPrice.value = this.settingsGasPrice;

            var _this = this;
            this.$.lang.addEventListener('value-changed', function() {
                _this.settingsLang = _this.$.lang.value || "en";
                console.log(_this.settingsLang);
            });

            this.$.currency.addEventListener('value-changed', function() {
                _this.settingsCurrency = _this.$.currency.value || "usd";
                console.log(_this.settingsCurrency);
            });

            this.$.relay.addEventListener('value-changed', function() {
                _this.settingsRelay = _this.$.relay.value || "//relay1.loopring.io";
                console.log(_this.settingsRelay);
            });

            this.$.lrcFee.addEventListener('value-changed', function(e) {
                if(this._isLrcFee(this.$.lrcFee.value)){
                    this.$.settingsLrcFee.value = this.$.lrcFee.value;
                }
                console.log(this.$.settingsLrcFee.value)
            }.bind(this));

            this.$.gasPrice.addEventListener('value-changed', function() {
                _this.settingsGasPrice = _this.$.gasPrice.value;
                _this.$.gasPriceLabel.textContent = _this.$.gasPrice.value + "GWEI";
                console.log(_this.$.gasPrice.value)
            });

            this.$.marginSplit.addEventListener('value-changed', function() {
                this.$.settingsMarginSplit.value = this.$.marginSplit.value;
                console.log(this.$.settingsMarginSplit.value);
            }.bind(this));
        }

        _computedLrcFee(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                let value = null;
                if (cookieValues["settingsLrcFee"]) {
                    value = cookieValues["settingsLrcFee"];
                } else {
                    value = appConfig.defaultLrcFeePermillage;
                }
                this.$.lrcFee.value = value;
                return value;
            }
        }

        _initContract(appConfig, settingsVersion) {
            if(appConfig && settingsVersion){
                var _this = this;
                this.contractAddress = appConfig.contractVersionMap[settingsVersion].address;
                this.$.version.addEventListener('value-changed', function() {
                    _this.settingsVersion = _this.$.version.value;
                    _this.contractAddress = appConfig.contractVersionMap[_this.settingsVersion].address;
                });
            }
        }

        _computedMarginSplit(appConfig, cookieValues) {
            if (appConfig && cookieValues) {
                let value = null;
                if (cookieValues["settingsMarginSplit"]) {
                    value = cookieValues["settingsMarginSplit"];
                } else {
                    value = appConfig.defaultMarginSplitPercentage;
                }
                this.$.marginSplit.value = value;
                return value;
            }
        }

        _lrcFeePatten() {
            return "^([0-9]{1,3}|1000)$";
        }

        _isLrcFee(intVal) {
            return intVal.toString().match(this._lrcFeePatten());
        }

        _lrcFeeError(int) {
            return "input valid integer value (0~50)";
        }

        _marginSplitPatten() {
            return "^([0-9]{1,3}|1000)$";
        }

        _marginSplitFee(intVal) {
            return intVal.toString().match(this._marginSplitPatten());
        }

        _marginSplitError(int) {
            return "input valid integer value (0~100)";
        }
    }

    window.customElements.define(PageSettings.is, PageSettings);
    </script>
</dom-module>