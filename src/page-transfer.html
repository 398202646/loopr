<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="page-transfer">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles">
         :host {
            display: block;
        }

        .container {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
            margin: 50px;
        }

        .flexleft {
            @apply(--layout-vertical);
            width: 400px;
        }

        .flexright {
            @apply(--layout-vertical);
            @apply(--layout-flex);
            width: 100px;
            padding-left: 40px;
            margin-left: 100px;
        }

        .flexright>.hr {
            width: 350px;
        }

        .fontContent {
            font-family: Georgia, serif;
            font-size: 0.875em;
        }

        iron-list {
            flex: 1 1 auto;
        }

        .hidden {
            display: none;
        }

        iron-input>input {
            width: 350px;
            height: 34px;
            padding-bottom: 0px;
        }

        iron-input>.amount {
            width: 150px;
            height: 34px;
            padding-bottom: 0px;
        }

        .line {
            @apply(--layout-horizontal);
            @apply(--layout-start-justified);
            margin-top: 10px;
        }

        .line div{
            height:36px;
        }

        .lineHoriziontal {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
            margin-top: 20px;
        }
        .input{
            margin-bottom: var(--valo-space-xs);
        }
        </style>
        <looper-page>
            <global-variable key="wallet" value="{{wallet}}"></global-variable>
            <global-variable key="app-config" value="{{appConfig}}"></global-variable>
            <global-variable key="settings-relay" value="{{settingsRelay}}"></global-variable>
            <scary-cookie name="settings-relay" value="{{settingsRelay}}"></scary-cookie>
            <simple-toolbar slot="secondary-toolbar" title="Transfer" back-link="#/wallet"></simple-toolbar>
            <div class="sections">
                <paper-card>
                    <div class="container">
                        <div class="flexleft">
                            <div class="line">
                                Send To:
                            </div>
                            <div class="horizontal layout start-justified">
                                <iron-input>
                                    <input>
                                </iron-input>
                            </div>
                            <div class="line">
                                Amount to Send:
                            </div>
                            <div class="horizontal layout start-justified">
                                <div class="vertical layout end-justified input">
                                    <iron-input>
                                        <input class="amount">
                                    </iron-input>
                                </div>
                                <vaadin-combo-box id="tokensSelector" items="[[tokens]]" item-label-path="token" item-value-path="token"></vaadin-combo-box>
                            </div>
                            <div class="line">
                                Gas Limit:
                            </div>
                            <div class="horizontal layout start-justified">
                                <iron-input>
                                    <input>
                                </iron-input>
                            </div>
                            <div class="line">
                                <a href="#" on-click="handleClick">+Advanced: Add Data</a>
                            </div>
                            <div class="hidden" id="hiddenExtData">
                                <div class="line">
                                    Data:
                                </div>
                                <div class="horizontal layout start-justified">
                                    <iron-input>
                                        <input>
                                    </iron-input>
                                </div>
                            </div>
                            <div class="lineHoriziontal">
                                <paper-button primary raised on-click="signToSend">Generate Transaction</paper-button>
                            </div>
                        </div>
                        <div class="flexright">
                            <paper-item class="flex">
                                <paper-item-body two-line>
                                    <div class="title"> Account Address</div>
                                    <div secondary>
                                        [[wallet.address]]
                                    </div>
                                </paper-item-body>
                            </paper-item>
                            <paper-item class="flex">
                                <paper-item-body two-line>
                                    <div class="title"> [[_toUpper(token)]] Balance</div>
                                    <div secondary>
                                        <iron-ajax url="[[relay]]/Loopring/mock-relay-data/master/balances.json" last-response="{{rawBalances}}" auto></iron-ajax>
                                        [[_showTokenBalance(selectedTokenBalance)]]
                                    </div>
                                </paper-item-body>
                            </paper-item>
                        </div>
                    </div>
                </paper-card>
                <div class="footer-spacer"></div>
                <looper-footer></looper-footer>
            </div>
        </looper-page>
    </template>
    <script>
    class PageTransfer extends Polymer.Element {
        static get is() { return 'page-transfer'; }

        static get properties() {
            return {
                token: {
                    type: String
                },
                tokens: {
                    type: Object,
                    computed: '_computeTokens(rawBalances)'
                },
                balances: {
                    type: Object,
                    computed: '_computeBalances(rawBalances)',
                },
                relay: {
                    type: String,
                    computed: '_selectedRelay(settingsRelay)'
                },
                selectedTokenBalance: {
                    type: Object,
                    computed: '_selectedToken(appConfig, balances, token)'
                },
            }
        }

        _selectedRelay(settingsRelay){
            return settingsRelay;
        }

        _computeTokens(rawBalances){
            if(rawBalances){
                return _.map(rawBalances.result.tokens);
            }
        }

        _computeBalances(data){
            if(data){
                return _.keyBy(data.result.tokens, o => o.token);
            }
        }

        _selectedToken(appConfig, balances, token){
            if(appConfig && balances && token){
                var combobox = this.$.tokensSelector;
                combobox.value = token.toUpperCase();
                return this._getTokenBalance(appConfig, balances, token);
            }
        }

        _getTokenBalance(appConfig, balances, selectedToken){
            let selected = balances[selectedToken.toUpperCase()];
            let balance = 0, allowance = 0
            if(selected) {
                balance = selected.balance;
                allowance = selected.allowance
            }
            let tokenConfig = appConfig.tokenMap[selectedToken.toUpperCase()];
            if (!tokenConfig) {
                return;
            }
            return {
               token: selectedToken,
               unit: tokenConfig.unit,
               balance: balance,
               availableAllowance: allowance,
               defaultAllowance: tokenConfig.allowanceWarn
            }
        }

        _showTokenBalance(selectedTokenBalance) {
            if(selectedTokenBalance) {
                return selectedTokenBalance.balance;
            }
        }

        ready() {
//            if(!this.wallet){
//                window.location.href = "#/wallet"
//                return
//            }
            super.ready();
            var combobox = this.$.tokensSelector
            var context = this
            combobox.addEventListener('value-changed', function() {
                context.token = combobox.value
            });
        }

        handleClick() {
            var extData = this.$.hiddenExtData;
            if (extData.style.display == 'block') {
                extData.style.display = 'none';
            } else {
                extData.style.display = 'block';
            }
        }

        signToSend() {
            var detail = { raw: "raw message" };
            this.dispatchEvent(new CustomEvent('signtosend', { bubbles: true, composed: true, detail: detail }));
        }
    }
    window.customElements.define(PageTransfer.is, PageTransfer);
    </script>
</dom-module>