<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="subpage-ready" fit>
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
        <style include="shared-styles">
         :host {
            display: block;
        }

        .warning {
            color: var(--paper-amber-700);
        }

        .allowance {
            @apply --layout-horizontal;
            @apply --center-justified-horizontal;
        }

        .operations {
            @apply --layout-horizontal;
        }

        .operations a {
            min-width: 60px;
            text-align: center;
        }

        .summary {
            font-size: 20px;
            font-weight: 700;
            text-transform: uppercase;
        }
         .summary >div {
            padding: 8px;
         }
        </style>
        <global-variable key="wallet" value="{{wallet}}"></global-variable>
        <global-variable key="app-config" value="{{appConfig}}"></global-variable>
        <iron-ajax auto url="https://raw.githubusercontent.com/Loopring/mock-relay-data/master/balances.json" handle-as="json" last-response="{{resp}}" debounce-duration="300"></iron-ajax>
        <div class="sections">
            <paper-card transparent>
                <div class="summary horizontal center center-justified layout">
                    <div>Wallet Total Value:</div>
                    <div>1234552323.1212 USD</div>
                </div>
            </paper-card>
            <paper-card transparent>Ether</paper-card>
            <paper-card>
                <vaadin-grid aria-label="Tokens" items="[[etherTokens]]">
                    <vaadin-grid-column>
                        <template class="header">Name</template>
                        <template>[[item.name]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Balance</template>
                        <template>
                            <pretty-number v=[[item.balanceValue]] d=[[item.precision]] postfix="[[item.unit]]"></pretty-number>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="60px">
                        <template class="header">Price (USD)</template>
                        <template>
                            <pretty-number v=12 d=1 postfix="abc"></pretty-number>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="50px">
                        <template class="header">Allowance</template>
                        <template>
                            <div class="allowance">
                                <template is="dom-if" if="[[item.allowanceWarning]]">
                                    <iron-icon id="warn-[[item.token]]" class="warning" icon="warning"></iron-icon>
                                    <paper-tooltip for="warn-[[item.token]]" position="left">
                                        Your [[item.token]] allowance for Loopring protocol is lower than our suggested threshold.
                                    </paper-tooltip>
                                </template>
                                <pretty-number v=[[item.allowanceValue]] d=[[item.precision]] postfix="[[item.unit]]"></pretty-number>
                            </div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="100px">
                        <template class="header"></template>
                        <template>
                            <div class="operations">
                                <a href="#/transfer/[[item.token]]">Transfer</a>
                                <a href="#/convert">Convert</a>
                                <template is="dom-if" if="[[_isWETH(item.token)]]">
                                    <a href="#/authorize/[[item.token]]">Authorize</a>
                                </template>
                            </div>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </paper-card>
            <paper-card transparent>ERC20 Tokens</paper-card>
            <paper-card>
                <vaadin-grid aria-label="Tokens" items="[[erc20Tokens]]">
                    <vaadin-grid-column>
                        <template class="header">Name</template>
                        <template>[[item.name]]</template>
                    </vaadin-grid-column>
                    <vaadin-grid-column>
                        <template class="header">Balance</template>
                        <template>
                            <pretty-number v=[[item.balanceValue]] d=[[item.precision]] postfix="[[item.unit]]"></pretty-number>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="60px">
                        <template class="header">Price (USD)</template>
                        <template>
                            <pretty-number v=12 d=1 postfix="abc"></pretty-number>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="50px">
                        <template class="header">Allowance</template>
                        <template>
                            <div class="allowance">
                                <template is="dom-if" if="[[item.allowanceWarning]]">
                                    <iron-icon id="warn-[[item.token]]" class="warning" icon="warning"></iron-icon>
                                    <paper-tooltip for="warn-[[item.token]]" position="left">
                                        Your [[item.token]] allowance for Loopring protocol is lower than our suggested threshold.
                                    </paper-tooltip>
                                    <pretty-number v=[[item.allowanceValue]] d=[[item.precision]] postfix="[[item.unit]]"></pretty-number>
                                </template>
                            </div>
                        </template>
                    </vaadin-grid-column>
                    <vaadin-grid-column width="100px">
                        <template class="header"></template>
                        <template>
                            <div class="operations">
                                <a href="#/transfer/[[item.token]]">Transfer</a>
                                <a href="#/market/[[item.token]]-WETH">Trade</a>
                                <a href="#/authorize/[[item.token]]">Authorize</a>
                            </div>
                        </template>
                    </vaadin-grid-column>
                </vaadin-grid>
            </paper-card>
    </template>
    <script>
    class SubpageReady extends Polymer.Element {
        static get is() { return 'subpage-ready'; }

        static get properties() {
            return {
                resp: Object,
                etherTokens: Array,
                erc20Tokens: {
                    type: Array,
                    computed: '_computeBalances(resp)'
                }

            };
        }

        _computeBalances(resp) {
            if (resp) {
                const items = _.map(resp.result.tokens, function(i) {
                    var item = i;
                    const tokenConfig = this.appConfig.tokenMap[i.token];
                    if (!tokenConfig) { return null; }

                    if (tokenConfig.name) {
                        item.name = tokenConfig.name + "/" + i.token;
                    } else {
                        item.name = i.token;
                    }
                    item.balanceValue = this.appConfig.toNumber(i.balance, tokenConfig);
                    item.allowanceValue = this.appConfig.toNumber(i.allowance, tokenConfig);
                    item.precision = tokenConfig.precision;
                    item.unit = tokenConfig.unit;
                    item.address = tokenConfig.address;
                    item.allowanceWarning = (item.allowanceValue < tokenConfig.allowanceWarn);
                    return item;
                }.bind(this));

                this.etherTokens = _.filter(items, function(i) {
                    return i !== null && (i.token === 'WETH' || i.token === 'ETH');
                });

                return _.filter(items, function(i) {
                    return i !== null && i.token !== 'WETH' && i.token !== 'ETH';
                });
            }
        }

        _isWETH(token) { return token === 'WETH'; }
    }

    window.customElements.define(SubpageReady.is, SubpageReady);
    </script>
</dom-module>